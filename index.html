<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wide Weather + Time Widget (Dynamic Background + Intensity)</title>
  <style>
    :root{
      --bg:#0f1226; --card:#171a33; --accent:#4cc9f0; --accent-2:#b5179e;
      --text:#e6e6f0; --muted:#a8a8c0; --shadow:0 10px 30px rgba(0,0,0,.35);

      /* === íš¨ê³¼ íŒŒë¼ë¯¸í„°(ê¸°ë³¸ê°’) === */
      /* Rain */
      --rain-speed:.9s;          /* ë‚®ì„ìˆ˜ë¡ ë¹ ë¦„ */
      --rain-gap:7px;            /* ìŠ¤íŠ¸ë¼ì´í”„ ê°„ê²©(ì‘ì„ìˆ˜ë¡ ì´˜ì´˜) */
      --rain-streak:2px;         /* ë¹—ì¤„ê¸° ë‘ê»˜ */
      --rain-opacity:.18;        /* ë¹—ì¤„ê¸° ëª…ë„ */
      --rain-tilt:-45deg;        /* ë¹—ì¤„ê¸° ê¸°ìš¸ê¸°(ë°”ëŒ ì˜í–¥) */

      /* Snow */
      --snow-speed:12s;          /* ë‚®ì„ìˆ˜ë¡ ë¹ ë¦„ */
      --snow-s1:1.2px;           /* ëˆˆì†¡ì´ í¬ê¸°(ì‘ì€ ì¸µ) */
      --snow-s2:1.6px;           /* ì¤‘ê°„ */
      --snow-s3:2.0px;           /* í° ì¸µ */
      --snow-opacity:.9;         /* ì „ë°˜ íˆ¬ëª…ë„(ê²¹ì¹¨) */

      /* Fog */
      --fog-a1:.18;              /* ì „ë©´ ë² ì¼ ê°•ë„ */
      --fog-a2:.14;              /* í›„ë©´ ë² ì¼ ê°•ë„ */
    }
    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0;
      background:linear-gradient(135deg,#0b0f26 0%,#1b1f46 100%);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial
    }

    /* ---------- ë™ì  í…Œë§ˆ ë°°ê²½ ---------- */
    body.theme-clear-day{   background: linear-gradient(135deg,#87CEEB 0%, #f6d365 100%); }
    body.theme-clear-night{ background: radial-gradient(100% 150% at 50% -30%, #22304a 0%, #0b1020 60%, #050816 100%); }
    body.theme-cloudy{      background: linear-gradient(135deg,#757f9a 0%, #d7dde8 100%); }
    body.theme-rain{        background: linear-gradient(180deg,#0f2027 0%, #203a43 50%, #2c5364 100%); }
    body.theme-snow{        background: linear-gradient(180deg,#99c1de 0%, #cfe7ff 100%); }
    body.theme-fog{         background: linear-gradient(180deg,#b8c6db 0%, #f5f7fa 100%); }
    body.theme-thunder{     background: linear-gradient(180deg,#0b0f26 0%, #121a2f 60%, #050816 100%); }

    /* íš¨ê³¼ ì˜¤ë²„ë ˆì´ (ë¹„/ëˆˆ/ì•ˆê°œ) */
    #fx{ position:fixed; inset:0; pointer-events:none; z-index:0; }

    /* ë¹„: ëŒ€ê°ì„  ë¹—ì¤„ê¸° (ë³€ìˆ˜ë¡œ ê°•ë„/ì†ë„/ë‘ê»˜/ê°„ê²©/ê¸°ìš¸ê¸° ì œì–´) */
    #fx.fx-rain::before{
      content:"";
      position:absolute; inset:-40%;
      background: repeating-linear-gradient(
        var(--rain-tilt),
        rgba(255,255,255,var(--rain-opacity)) 0px,
        rgba(255,255,255,var(--rain-opacity)) var(--rain-streak),
        rgba(255,255,255,0) calc(var(--rain-streak) + 0.1px),
        rgba(255,255,255,0) calc(var(--rain-streak) + var(--rain-gap))
      );
      filter: blur(.2px);
      animation: rainMove var(--rain-speed) linear infinite;
      transform: rotate(0.001deg);
    }
    @keyframes rainMove{
      0%{ background-position: 0 0; }
      100%{ background-position: -200px 200px; }
    }

    /* ëˆˆ: 3ì¸µ ì…ì (ë³€ìˆ˜ë¡œ í¬ê¸°/ì†ë„/íˆ¬ëª…ë„ ì œì–´) */
    #fx.fx-snow{
      background-image:
        radial-gradient(#fff var(--snow-s1), transparent calc(var(--snow-s1) + .1px)),
        radial-gradient(#fff var(--snow-s2), transparent calc(var(--snow-s2) + .1px)),
        radial-gradient(#fff var(--snow-s3), transparent calc(var(--snow-s3) + .1px));
      background-size: 8px 12px, 10px 14px, 6px 10px; /* ë°€ë„ëŠ” ì‚¬ì´ì¦ˆë¡œ ê°„ì ‘ ì œì–´ */
      background-position: 0 0, 0 -40px, 0 -80px;
      animation: snowFall var(--snow-speed) linear infinite;
      opacity: var(--snow-opacity);
    }
    @keyframes snowFall{
      0%{   background-position: 0 0, 0 -40px, 0 -80px; }
      100%{ background-position: 0 600px, 0 560px, 0 520px; }
    }

    /* ì•ˆê°œ: ë² ì¼ ë‘ ê²¹ (ë³€ìˆ˜ë¡œ ë†ë„ ì œì–´) */
    #fx.fx-fog::before{
      content:"";
      position:absolute; inset:-10%;
      background:
        radial-gradient(60% 30% at 20% 50%, rgba(255,255,255,var(--fog-a1)), rgba(255,255,255,0) 60%),
        radial-gradient(50% 25% at 80% 55%, rgba(255,255,255,var(--fog-a2)), rgba(255,255,255,0) 60%);
      filter: blur(8px);
      animation: fogDrift 20s ease-in-out infinite alternate;
    }
    @keyframes fogDrift{ 0%{ transform: translateX(-4%);} 100%{ transform: translateX(4%);} }

    /* ë²ˆê°œ: ë‚®ì€ ë¹ˆë„ ë²ˆì©ì„ */
    body.theme-thunder #fx::after{
      content:""; position:absolute; inset:0; mix-blend-mode: screen;
      animation: flash 7s linear infinite;
    }
    @keyframes flash{
      0%,96%,100%{ background: transparent; }
      97%{ background: radial-gradient(60% 40% at 50% 20%, rgba(255,255,255,.35), rgba(255,255,255,0) 60%); }
      98%{ background: radial-gradient(25% 15% at 60% 25%, rgba(255,255,255,.5), rgba(255,255,255,0) 60%); }
      99%{ background: transparent; }
    }

    @media (prefers-reduced-motion: reduce){
      #fx, #fx::before, #fx::after{ animation:none !important }
    }

    .container{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px; position:relative; z-index:1;}
    .widget{
      width:min(1280px,96vw);
      background:linear-gradient(160deg,var(--card),#1c2144 60%, #131734 100%);
      color:var(--text); border-radius:20px; box-shadow:var(--shadow); overflow:hidden;
      display:grid; grid-template-rows:auto 1fr; grid-template-columns: .9fr .8fr 1.3fr; gap:0 18px;
      grid-template-areas: "header header header" "main details forecast";
      padding:18px 22px 22px; position:relative;
    }
    .widget::before{
      content:""; position:absolute; inset:-2px; z-index:-1; border-radius:22px;
      background: conic-gradient(from 180deg at 50% 50%, #4cc9f0, #b5179e, #f72585, #4cc9f0);
      filter:blur(16px); opacity:.15;
    }
    @media (max-width:900px){
      .widget{
        grid-template-columns: 1fr;
        grid-template-areas: "header" "main" "details" "forecast";
        row-gap:16px;
      }
    }
    header{grid-area:header; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    header .search{flex:1; display:flex; gap:8px; min-width:280px}
    input[type="search"]{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#0e1128; color:var(--text); outline:none;
    }
    button,.chip{ background:var(--accent); color:#07223a; border:none; border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer; }
    button.secondary{ background:#0e1128; color:var(--text); border:1px solid rgba(255,255,255,.08) }
    .units{display:flex; flex-direction: column; align-items:center; gap:8px; margin-left:auto; align-self: flex-start;}
    .units .active{ background:var(--accent-2); color:#fff }
    .place-line{width:100%; display:flex; align-items:center; gap:10px; color:var(--muted); font-size:14px; margin-top:4px}

    /* â†“â†“â†“ ë²„íŠ¼ ê¸€ì í¬ê¸°/íŒ¨ë”© í•œ ë‹¨ê³„ ì‘ê²Œ */
    header .search button,
    header .search button.secondary {
      font-size: 0.85em;
      padding: 8px 9px;
    }

    .main{grid-area:main; display:flex; gap:18px; align-items:center}
    .icon-xxl{font-size:64px; filter:drop-shadow(0 6px 10px rgba(0,0,0,.35))}
    .temp{font-size:72px; font-weight:800; letter-spacing:-1px}
    .temp .unit{font-size:.5em; color:var(--muted); margin-left:4px}
    .cond{color:var(--muted); margin-top:2px}

    .clock{font-variant-numeric:tabular-nums; color:#f1f1f7; margin-top:6px; line-height:1.12}
    .clock .date{display:block; font-size:18px; opacity:.95}
    .clock .time{display:block; font-size:24px; font-weight:800; margin-top:2px}

    .details{grid-area:details; display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    .tile{background:rgba(255,255,255,.05); padding:12px; border-radius:12px}
    .tile .label{color:var(--muted); font-size:12px}
    .tile .value{font-weight:700; font-size:18px}

    .forecast{grid-area:forecast; display:grid; grid-template-columns:repeat(3, minmax(120px,1fr)); gap:12px}
    .day{background:rgba(255,255,255,.05); padding:12px; border-radius:12px; text-align:center}
    .day .d{color:var(--muted); font-size:12px}
    .day .i{font-size:28px; margin:4px 0}
    .day .t{font-weight:700}

    .note{grid-column:1/-1; color:var(--muted); font-size:12px; margin-top:6px}
    .error{color:#ffb4b4}
  </style>
</head>
<body>
  <!-- ë‚ ì”¨ íš¨ê³¼ ì˜¤ë²„ë ˆì´ -->
  <div id="fx" aria-hidden="true"></div>

  <div class="container">
    <div class="widget" id="app">
      <header>
        <div class="search">
          <input id="q" type="search" placeholder="ë„ì‹œëª…ìœ¼ë¡œ ê²€ìƒ‰ (ì˜ˆ: Seoul, Tokyo, New York)" />
          <button id="btnSearch">ê²€<br><br>ìƒ‰</button>
          <button id="btnGeo" class="secondary">ë‚´<br>ìœ„ì¹˜</button>
        </div>
        <div class="units">
          <button id="btnC" class="active">â„ƒ</button>
          <button id="btnF">â„‰</button>
        </div>
        <div class="place-line">
          <span id="place">ë¡œë”© ì¤‘...</span>
          <span id="tz" class="chip" title="Time Zone"></span>
        </div>
      </header>

      <section class="main">
        <div class="icon-xxl" id="icon">â›…ï¸</div>
        <div>
          <div class="temp" id="temp">--<span class="unit">Â°C</span></div>
          <div class="cond" id="cond">-</div>
          <div class="clock" id="clock">
            <span class="date">--</span>
            <span class="time">--</span>
          </div>
        </div>
      </section>

      <section class="details">
        <div class="tile"><div class="label">ì²´ê°</div><div class="value" id="feels">--</div></div>
        <div class="tile"><div class="label">í’ì†</div><div class="value" id="wind">--</div></div>
        <div class="tile"><div class="label">ìŠµë„</div><div class="value" id="rh">--</div></div>
        <div class="tile"><div class="label">ì˜¤ëŠ˜ ìµœê³ /ìµœì €</div><div class="value"><span id="tmax">--</span> <span style="color:var(--muted)">/</span> <span id="tmin">--</span></div></div>
      </section>

      <section class="forecast" id="forecast"></section>

      <div class="note">
        ì•¼ê·¼í•˜ì§€ë§ê³  ì¹¼í‡´ ã„±
        <div class="note error" id="err"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = s => document.querySelector(s);
    const state = {
      lat:40.7128, lon:-74.0060, placeText:"New York, US",
      units:"C", tz:"America/New_York", clockTimer:null, raw:null
    };
    const cToF = c => c*9/5+32;
    const fmtTemp = vC => (vC==null||Number.isNaN(vC)) ? "--" : Math.round(state.units==="C"?vC:cToF(vC)) + "Â°" + state.units;
    // í’ì† m/s (ì†Œìˆ˜ 1ìë¦¬)
    const fmtSpeed = ms => (ms==null||Number.isNaN(ms)) ? "--" : (Math.round(ms*10)/10).toFixed(1) + " m/s";
    const fmtPct = p => (p!=null) ? Math.round(p) + " %" : "--";

    function iconFor(code,isDay){
      const sun="â˜€ï¸", moon="ğŸŒ™", cloud="â˜ï¸", sunCloud="â›…ï¸", rain="ğŸŒ§ï¸", drizzle="ğŸŒ¦ï¸", thunder="â›ˆï¸", snow="ğŸŒ¨ï¸", fog="ğŸŒ«ï¸", hail="ğŸŒ©ï¸";
      let label="â€”", icon=sunCloud;
      switch(true){
        case code===0: icon=isDay?sun:moon; label="ë§‘ìŒ"; break;
        case [1,2,3].includes(code): icon=sunCloud; label="êµ¬ë¦„ ì¡°ê¸ˆ"; break;
        case [45,48].includes(code): icon=fog; label="ì•ˆê°œ"; break;
        case [51,53,55,56,57].includes(code): icon=drizzle; label="ì´ìŠ¬ë¹„"; break;
        case [61,63,65,80,81,82].includes(code): icon=rain; label="ë¹„"; break;
        case [66,67].includes(code): icon=hail; label="ì–´ëŠ” ë¹„"; break;
        case [71,73,75,77,85,86].includes(code): icon=snow; label="ëˆˆ"; break;
        case [95,96,99].includes(code): icon=thunder; label="ë‡Œìš°"; break;
        default: icon=cloud; label="íë¦¼";
      }
      return {icon,label};
    }

    // ë‚ ì”¨ ì½”ë“œ â†’ í…Œë§ˆëª…
    function themeFor(code,isDay){
      if (code===0) return isDay ? "clear-day" : "clear-night";
      if ([1,2,3].includes(code)) return "cloudy";
      if ([45,48].includes(code)) return "fog";
      if ([51,53,55,56,57,61,63,65,66,67,80,81,82].includes(code)) return "rain";
      if ([71,73,75,77,85,86].includes(code)) return "snow";
      if ([95,96,99].includes(code)) return "thunder";
      return "cloudy";
    }

    // === íš¨ê³¼ ë§¤í•‘: ì´ìŠ¬ë¹„/í­ìš°, ì•½í•œ ëˆˆ/í­ì„¤, ì•ˆê°œ ë†ë„ ===
    // ë°˜í™˜ê°’: { type:'rain'|'snow'|'fog'|null, level:'light'|'moderate'|'heavy' }
    function effectFromCode(code){
      // Drizzle: 51(ì•½),53(ì¤‘),55(ê°•), 56-57(ì–¸ ì´ìŠ¬ë¹„)
      if ([51,56].includes(code)) return {type:'rain', level:'light'};
      if ([53,57].includes(code)) return {type:'rain', level:'moderate'};
      if ([55].includes(code))     return {type:'rain', level:'heavy'};

      // Rain stratiform: 61(ì•½),63(ì¤‘),65(ê°•)
      if (code===61) return {type:'rain', level:'light'};
      if (code===63) return {type:'rain', level:'moderate'};
      if (code===65) return {type:'rain', level:'heavy'};

      // Showers: 80(ì•½),81(ì¤‘),82(ê°•)
      if (code===80) return {type:'rain', level:'light'};
      if (code===81) return {type:'rain', level:'moderate'};
      if (code===82) return {type:'rain', level:'heavy'};

      // Freezing rain: 66(ì•½),67(ê°•) â†’ ë¹„ íš¨ê³¼(ì°¨ê°€ìš´ ìƒ‰ê°ì€ í…Œë§ˆë¡œ ì²˜ë¦¬)
      if (code===66) return {type:'rain', level:'moderate'};
      if (code===67) return {type:'rain', level:'heavy'};

      // Snow: 71(ì•½),73(ì¤‘),75(ê°•=í­ì„¤)
      if (code===71) return {type:'snow', level:'light'};
      if (code===73) return {type:'snow', level:'moderate'};
      if (code===75) return {type:'snow', level:'heavy'};
      // Snow grains 77 â†’ ì•½~ì¤‘
      if (code===77) return {type:'snow', level:'moderate'};
      // Snow showers: 85(ì•½),86(ê°•)
      if (code===85) return {type:'snow', level:'light'};
      if (code===86) return {type:'snow', level:'heavy'};

      // Fog: 45(ë³´í†µ),48(ì°©ë¹™ì•ˆê°œ=ì§™ìŒ)
      if (code===45) return {type:'fog', level:'moderate'};
      if (code===48) return {type:'fog', level:'heavy'};

      return {type:null, level:'light'};
    }

    // íŒŒë¼ë¯¸í„° ì ìš© (CSS ë³€ìˆ˜ ì„¸íŒ…)
    function setEffectParams({type, level, windMs=0}){
      const root = document.documentElement.style;

      if (type==='rain'){
        // ë°”ëŒì— ë”°ë¥¸ ê¸°ìš¸ê¸°: ê¸°ë³¸ -35degì—ì„œ í’ì†ì— ë”°ë¼ ë” ëˆ•í˜
        const tilt = -35 - Math.min(20, windMs*2); // ì œí•œ: -55degê¹Œì§€
        root.setProperty('--rain-tilt', tilt+'deg');

        // ê°•ë„ë³„ íŒŒë¼ë¯¸í„°
        if (level==='light'){
          root.setProperty('--rain-speed','1.1s');
          root.setProperty('--rain-streak','1px');
          root.setProperty('--rain-gap','8px');
          root.setProperty('--rain-opacity','.12');
        }else if (level==='moderate'){
          root.setProperty('--rain-speed','.85s');
          root.setProperty('--rain-streak','2px');
          root.setProperty('--rain-gap','6px');
          root.setProperty('--rain-opacity','.18');
        }else{ // heavy = í­ìš°
          root.setProperty('--rain-speed','.55s');
          root.setProperty('--rain-streak','3px');
          root.setProperty('--rain-gap','5px');
          root.setProperty('--rain-opacity','.28');
        }
      }

      if (type==='snow'){
        if (level==='light'){
          root.setProperty('--snow-speed','16s');
          root.setProperty('--snow-s1','0.9px');
          root.setProperty('--snow-s2','1.2px');
          root.setProperty('--snow-s3','1.5px');
          root.setProperty('--snow-opacity','.75');
        }else if (level==='moderate'){
          root.setProperty('--snow-speed','12s');
          root.setProperty('--snow-s1','1.2px');
          root.setProperty('--snow-s2','1.6px');
          root.setProperty('--snow-s3','2.0px');
          root.setProperty('--snow-opacity','.9');
        }else{ // heavy = í­ì„¤
          root.setProperty('--snow-speed','8s');
          root.setProperty('--snow-s1','1.6px');
          root.setProperty('--snow-s2','2.2px');
          root.setProperty('--snow-s3','2.8px');
          root.setProperty('--snow-opacity','1');
        }
      }

      if (type==='fog'){
        if (level==='light'){
          root.setProperty('--fog-a1','.10'); root.setProperty('--fog-a2','.06');
        }else if (level==='moderate'){
          root.setProperty('--fog-a1','.16'); root.setProperty('--fog-a2','.10');
        }else{ // heavy
          root.setProperty('--fog-a1','.25'); root.setProperty('--fog-a2','.16');
        }
      }
    }

    // í…Œë§ˆ ì ìš© (ë°°ê²½ + íš¨ê³¼ ì˜¤ë²„ë ˆì´)
    function applyTheme(theme){
      const body = document.body;
      const fx = $("#fx");
      const all = ["theme-clear-day","theme-clear-night","theme-cloudy","theme-rain","theme-snow","theme-fog","theme-thunder"];
      body.classList.remove(...all);
      body.classList.add("theme-" + theme);

      fx.className = ""; // reset
      if (theme === "rain") fx.classList.add("fx-rain");
      else if (theme === "snow") fx.classList.add("fx-snow");
      else if (theme === "fog") fx.classList.add("fx-fog");
      // thunderëŠ” body.theme-thunder #fx::afterì—ì„œ ë²ˆì©ì„ ì²˜ë¦¬
    }

    const setError = msg => $("#err").textContent = msg || "";

    // ---------- Clock (ë‘ ì¤„ í¬ë§·) ----------
    function startClock(){
      if (state.clockTimer) clearInterval(state.clockTimer);
      const tz = state.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
      const tick = () => {
        const now = new Date();
        const datePart = new Intl.DateTimeFormat('ko-KR',{year:'numeric', month:'long', day:'numeric', timeZone: tz}).format(now);
        const weekday = new Intl.DateTimeFormat('ko-KR',{weekday:'long', timeZone: tz}).format(now);
        const timePart = new Intl.DateTimeFormat('ko-KR',{hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone: tz}).format(now);
        const clockEl = $("#clock");
        clockEl.innerHTML = `<span class="date">${datePart}</span><span class="time">${weekday} ${timePart}</span>`;
      };
      tick();
      state.clockTimer = setInterval(tick, 1000);
    }

    // ---------- Render ----------
    function render(){
      const d = state.raw; if(!d) return;
      const cur = d.current; const daily = d.daily;

      const isDay = (cur.is_day===1);
      const ic = iconFor(cur.weather_code, isDay);
      $("#icon").textContent = ic.icon;
      $("#cond").textContent = ic.label;

      $("#temp").innerHTML = `${fmtTemp(cur.temperature_2m)}<span class="unit"></span>`;
      $("#feels").textContent = fmtTemp(cur.apparent_temperature);
      $("#wind").textContent = fmtSpeed(cur.wind_speed_10m);
      $("#rh").textContent = fmtPct(cur.relative_humidity_2m);

      $("#place").textContent = state.placeText;
      $("#tz").textContent = state.tz?.replace("_"," ") || "";

      if (daily && daily.time && daily.time.length){
        $("#tmax").textContent = fmtTemp(daily.temperature_2m_max[0]);
        $("#tmin").textContent = fmtTemp(daily.temperature_2m_min[0]);
      }

      // 3ì¼ ì˜ˆë³´ (ì˜¤ëŠ˜ ì œì™¸ + ë‹¤ìŒ 3ì¼)
      const fcEl = $("#forecast"); fcEl.innerHTML = "";
      const maxDays = 3;
      const count = Math.min(maxDays, (daily?.time?.length || 1) - 1);
      for (let i=1; i<=count; i++){
        const code = daily.weather_code[i];
        const dd = iconFor(code,true);
        const date = new Date(daily.time[i]+"T12:00:00");
        const dstr = date.toLocaleDateString('ko-KR',{weekday:'short', month:'numeric', day:'numeric'});
        const hi = fmtTemp(daily.temperature_2m_max[i]);
        const lo = fmtTemp(daily.temperature_2m_min[i]);
        const node = document.createElement("div");
        node.className = "day";
        node.innerHTML = `
          <div class="d">${dstr}</div>
          <div class="i">${dd.icon}</div>
          <div class="t">${hi} <span style="color:var(--muted)">/ ${lo}</span></div>
        `;
        fcEl.appendChild(node);
      }

      // ë°°ê²½ í…Œë§ˆ + ê°•ë„ë³„ íš¨ê³¼ ì ìš©
      const theme = themeFor(cur.weather_code, isDay);
      applyTheme(theme);
      const eff = effectFromCode(cur.weather_code);
      setEffectParams({type: eff.type, level: eff.level, windMs: cur.wind_speed_10m});
    }

    // ---------- Data ----------
    async function geocode(name){
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=ko&format=json`;
      const r = await fetch(url);
      if(!r.ok) throw new Error("ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨");
      const j = await r.json();
      if(!j.results || j.results.length===0) throw new Error("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ");
      const g = j.results[0];
      const place = [g.name, g.admin1, g.country_code].filter(Boolean).join(", ");
      return {lat:g.latitude, lon:g.longitude, place, tz:g.timezone || null};
    }
    async function fetchWeather(lat,lon){
      const url = new URL("https://api.open-meteo.com/v1/forecast");
      const params = {
        latitude:lat, longitude:lon,
        current:"temperature_2m,apparent_temperature,weather_code,wind_speed_10m,relative_humidity_2m,is_day",
        daily:"weather_code,temperature_2m_max,temperature_2m_min",
        timezone:"auto", forecast_days:4  // ì˜¤ëŠ˜+3ì¼
      };
      Object.entries(params).forEach(([k,v])=>url.searchParams.set(k,v));
      const r = await fetch(url.toString());
      if(!r.ok) throw new Error("ë‚ ì”¨ API ì‹¤íŒ¨");
      return r.json();
    }
    async function loadByQuery(q){
      setError("");
      try{
        const g = await geocode(q);
        state.lat=g.lat; state.lon=g.lon; state.placeText=g.place;
        const data = await fetchWeather(g.lat,g.lon);
        state.tz = data.timezone || g.tz || Intl.DateTimeFormat().resolvedOptions().timeZone;
        state.raw = data; render(); startClock();
      }catch(e){ console.error(e); setError(e.message || "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }
    async function loadByCoords(lat,lon,labelHint){
      setError("");
      try{
        let place = labelHint || "";
        try{
          const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=ko&format=json`;
          const r = await fetch(url);
          if (r.ok){
            const j = await r.json();
            const g = j?.results?.[0];
            if (g) place = [g.name, g.admin1, g.country_code].filter(Boolean).join(", ");
          }
        }catch(_){} // best-effort
        state.lat=lat; state.lon=lon; state.placeText = place || `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`;
        const data = await fetchWeather(lat,lon);
        state.tz = data.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
        state.raw = data; render(); startClock();
      }catch(e){ console.error(e); setError("í˜„ì¬ ìœ„ì¹˜ì˜ ë‚ ì”¨ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
    }

    // ---------- Events ----------
    $("#btnSearch").addEventListener("click", ()=>{
      const q=$("#q").value.trim(); if(q) loadByQuery(q);
    });
    $("#q").addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ const q=$("#q").value.trim(); if(q) loadByQuery(q); }
    });
    $("#btnGeo").addEventListener("click",()=>{
      if(!navigator.geolocation){ setError("ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
      navigator.geolocation.getCurrentPosition(
        pos=>{ const {latitude,longitude}=pos.coords; loadByCoords(latitude,longitude,"ë‚´ ìœ„ì¹˜"); },
        err=>{ setError("ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ ë˜ëŠ” ì˜¤ë¥˜: " + err.message); },
        {enableHighAccuracy:true, maximumAge:300000, timeout:10000}
      );
    });
    $("#btnC").addEventListener("click",()=>{ state.units="C"; $("#btnC").classList.add("active"); $("#btnF").classList.remove("active"); render(); });
    $("#btnF").addEventListener("click",()=>{ state.units="F"; $("#btnF").classList.add("active"); $("#btnC").classList.remove("active"); render(); });

    // ---------- Init ----------
    (async function init(){ await loadByQuery("Seoul"); })();
  </script>
</body>
</html>
